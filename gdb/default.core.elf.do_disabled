# $1 target
# $2 basename
# $3 temp

ARCH="${2##*.}"
BN=$(basename $2 .$ARCH)
ENV=./env.$ARCH.sh

cat <<EOF >&2
ARCH=$ARCH
ENV=$ENV
BN=$BN
EOF

# exit 1

redo-ifchange $ENV

. $ENV
redo-ifchange lib.$ARCH.a $BN.$ARCH.o $ARCH.core.ld $O_SYSTEM
$GCC $LDFLAGS -T$ARCH.core.ld -Wl,-Map=$BN.$ARCH..map -o $3 $BN.$ARCH.o $O_SYSTEM lib.$ARCH.a $LDLIBS
